#!/usr/bin/env sh
set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo "${GREEN}Running pre-push checks...${NC}"

# 获取 upstream（如果没有，直接检查所有文件）
UPSTREAM=$(git rev-parse --abbrev-ref --symbolic-full-name "@{u}" 2>/dev/null || true)

if [ -n "$UPSTREAM" ]; then
CHANGED_FILES=$(git diff --name-only "$UPSTREAM"..HEAD)
else
# 新分支 / 无 upstream
CHANGED_FILES=$(git diff --name-only HEAD)
fi

if [ -z "$CHANGED_FILES" ]; then
echo "${GREEN}No changes detected. Skipping checks.${NC}"
exit 0
fi

echo "${YELLOW}Changed files:${NC}"
echo "$CHANGED_FILES" | sed 's/^/  - /'

API_CHANGED=false
UI_CHANGED=false

echo "$CHANGED_FILES" | while read -r file; do
case "$file" in
api/*) API_CHANGED=true ;;
ui/*) UI_CHANGED=true ;;
esac
done

# shell 的 subshell 问题，重新判断
API_CHANGED=$(echo "$CHANGED_FILES" | grep -q '^api/' && echo true || echo false)
UI_CHANGED=$(echo "$CHANGED_FILES" | grep -q '^ui/' && echo true || echo false)

if [ "$API_CHANGED" = false ] && [ "$UI_CHANGED" = false ]; then
echo "${GREEN}No api/ or ui/ changes. Skipping checks.${NC}"
exit 0
fi

# ---------------- API ----------------
if [ "$API_CHANGED" = true ]; then
echo "${YELLOW}API changes detected${NC}"
cd api

    ./gradlew checkstyleMain
    ./gradlew pmdMain
    ./gradlew spotbugsMain
    ./gradlew test

    cd ..
    echo "${GREEN}API checks passed${NC}"
fi

# ---------------- UI ----------------
if [ "$UI_CHANGED" = true ]; then
echo "${YELLOW}UI changes detected${NC}"
cd ui

    npm run lint

    if npm run | grep -q "test"; then
        npm test -- --run
    fi

    cd ..
    echo "${GREEN}UI checks passed${NC}"
fi

echo "${GREEN}All pre-push checks passed!${NC}"
